image: chialab/php:7.1

stages:
  - test
  - deploy

before_script:
- ./install.sh

.job_template: &test_job
  stage: test

  services:
  - mysql

  variables:
    MYSQL_DATABASE: nexendrie_test
    MYSQL_ROOT_PASSWORD: root
    APP_USER: admin
    APP_PASSWORD: qwerty

  script:
  - ./vendor/bin/phing test

.job_template: &deploy_job
  stage: deploy

  script:
  - ./vendor/bin/phing deploy

test:default:
  <<: *test_job

test:cc:
  image: chialab/php-dev:7.1
  <<: *test_job
  script:
  - ./vendor/bin/phing test-coverage
  artifacts:
    name: "Code coverage"
    paths:
    - coverage.html

deploy:alpha:
  <<: *deploy_job
  environment: alpha
  only:
    - master@nexendrie/nexendrie
  variables:
    DEPLOY_ENVIRONMENT: alpha

deploy:beta:
  <<: *deploy_job
  environment: beta
  only:
    - tags
  variables:
    DEPLOY_ENVIRONMENT: beta
